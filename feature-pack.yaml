name: audit-core
title: System Audit
description: Audit Core feature pack (global audit events + admin UI + embeddable audit trail)

# ─────────────────────────────────────────────────────────────────────────────
# ROUTES - Frontend page routes
# ─────────────────────────────────────────────────────────────────────────────
routes:
  - path: /admin/audit
    page: AuditLogList
    roles: []
    default_roles_allow: [admin]
    authz: { entity: auditEvents, verb: read, require_action: audit-core.audit-log.access, show_pages: true }

# ─────────────────────────────────────────────────────────────────────────────
# NAVIGATION - Sidebar/topbar items
# ─────────────────────────────────────────────────────────────────────────────
nav:
  - id: audit
    label: Audit Logs
    path: /admin/audit
    icon: ClipboardList
    group: system
    weight: 910
    showWhen: authenticated
    roles: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/audit.ts
  exports:
    - auditEvents
    - AuditActorType
    - AuditEvent
    - InsertAuditEvent

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Backend endpoints
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    - path: /api/audit
      methods: [GET]
      handler: "@hit/feature-pack-audit-core/server/api/audit"
      description: "List audit events (admin-only; filterable by entity kind/id, actor, action, correlation)"

# ─────────────────────────────────────────────────────────────────────────────
# CONFIG - Feature pack configuration options
# ─────────────────────────────────────────────────────────────────────────────
config:
  schema:
    auto_audit:
      type: boolean
      default: true
      description: "Automatically audit all write operations (POST/PUT/PATCH/DELETE) via dispatcher. When true, handlers don't need to call writeAuditEvent manually for basic audit coverage."

requires:
  modules: []

dependencies:
  feature_packs:
    - name: erp-shell-core

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    # Audit pages with explicit access toggles.
    - key: audit-core.audit-log.access
      label: "Audit: Audit Log"
      description: "Access the system audit log."
      default_enabled: false

    # Scope Policy Tree: audit-core (global).
    #
    # Scope modes:
    # - none: deny all access for this verb/entity (hide pages + block APIs)
    # - all: ignore scope (read everything)
    # - own: only events where actorId matches current user
    # - ldd: events where actorId matches current user OR the actor's user has matching L/D/D
    #
    # These are mutually exclusive per node; the Security Groups UI renders them as dropdowns.
    - key: audit-core.read.scope.none
      label: "Audit Core Read Scope = None"
      description: "Deny all audit event read access."
      default_enabled: false
    - key: audit-core.read.scope.all
      label: "Audit Core Read Scope = All"
      description: "Read all audit events regardless of actor."
      default_enabled: false
    - key: audit-core.read.scope.own
      label: "Audit Core Read Scope = Own"
      description: "Read only audit events where you are the actor."
      default_enabled: false
